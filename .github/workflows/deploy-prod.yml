name: Deploy production

on:
  pull-request:
    branches: [main]

jobs:
  backup-database:
    runs-on: self-hosted

    environment:
      name: production
    
    permission:
      contents: read
      package: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login in Github Container
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN}}
      
      - name: Crear archivo .env.staging  
        run: echo "${{ secrets.PRODUCTION_ENV_FILE }}" > .env.prod

      - name: Realizar backup de la base de datos PostgreSQL
        run: |
          TIMESTAMP=$(date +%Y-%m-%d_%H%M%S)
          BACKUP_FILE="backup-prod-${TIMESTAMP}.sql"
          echo "Creando backup: ${BACKUP_FILE}..."
          
          docker compose --env-file .env.prod -f docker-compose.yml -f docker-compose.prod.yml \
            exec -T postgres sh -c 'pg_dump -U "$POSTGRES_USER" -d "$POSTGRES_DB"' > ${BACKUP_FILE}
          
          echo "Backup de producciÃ³n creado: ${BACKUP_FILE}"

      - name: Subir backup como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: prod-db-backup-${{ github.sha }}
          path: ./*.sql

  deployment:
    runs-on: self-hosted
    
    environment:
      name: production
    
    permission:
      contents: read
      package: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login in Github Container
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN}}

      - name: Crear archivo .env.production
        run: echo "${{secrets.PRODUCTION_ENV_FILE}}" > .env.prod

      - name: Despliegue de aplicaciones en prod
        run: |
          echo "Desplegando aplicaciones probadas en staging"
          docker compose --env-file .env.prod -f docker-compose.yml -f docker-compose.production.yml -up  -d --wait

      - name: Smoke tests Production
        run: |
          echo "Esperando que los servicios se estabilicen"
          sleep 10

          echo "Probando endpoint 'vote' (Produccion)"
          curl --fail http://localhost:80

          echo "Probando endpoint 'result' (Produccion)"
          curl --fail http://localhost:3000

